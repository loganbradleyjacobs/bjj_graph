<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BJJ Recursive Graph (Cytoscape)</title>
    <script src="https://unpkg.com/cytoscape@3.25.2/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/webcola/WebCola/cola.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cola/cytoscape-cola.js"></script>
    <style>
      :root {
        --ui-bg: rgba(0, 0, 0, 0.8);
        --ui-text: #fff;
        --ui-font: 12px sans-serif;
        --ui-border: 1px burlywood solid;
        --page-bg: rgba(80, 80, 80, 1);
      }
      html,
      body {
        width: 100%;
        height: 100%;
        background: var(--page-bg);
      }
      #cy {
        width: 100%;
        height: 100%;
        display: block;
      }
      .tooltip {
        position: fixed;
        background: var(--ui-bg);
        color: var(--ui-text);
        font: var(--ui-font);
        padding: 10px 10px;
        border-radius: 10px;
        border: var(--ui-border);
      }
      .layout-toggle {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 10;
        background: var(--ui-bg);
        color: var(--ui-text);
        font: var(--ui-font);
        padding: 6px 8px;
        border-radius: 6px;
        border: var(--ui-border);
      }
      .layout-toggle select {
        margin-left: 6px;
        background: var(--ui-bg);
        color: var(--ui-text);
        border-radius: 6px;
        border: var(--ui-border);
      }
      .layout-toggle .row {
        display: block;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div id="cy"></div>
    <div class="layout-toggle">
      <span class="row">
        Layout:
        <select id="layoutMode">
          <option value="cola">Cola</option>
          <option value="dagre">Dagre</option>
          <option value="concentric">Concentric</option>
        </select>
      </span>
      <span class="row">
        Edges:
        <select id="edgeStyleMode">
          <option value="straight">Straight</option>
          <option value="bezier">Bezier</option>
          <option value="unbundled-bezier">Unbundled Bezier</option>
          <option value="haystack">Haystack</option>
          <option value="segments">Segments</option>
          <option value="taxi">Taxi</option>
        </select>
      </span>
    </div>

    <script>
      async function loadGraph() {
        const layoutSelect = document.getElementById("layoutMode");
        const edgeStyleSelect = document.getElementById("edgeStyleMode");
        const res = await fetch("/moveset");
        const moves_json = await res.json();

        // Convert your JSON to Cytoscape elements
        const elements = [];

        // Add nodes
        Object.keys(moves_json).forEach((key) => {
          const move = moves_json[key];
          elements.push({
            data: {
              id: key,
              label: key,
              path: move.path,
              parents: move.parents,
              children: move.children,
              area: move.area,
              type: move.type,
            },
          });
        });

        // Add edges
        Object.keys(moves_json).forEach((key) => {
          const move = moves_json[key];
          if (move.children) {
            move.children.forEach((child) => {
              // Only add edge if child exists
              if (moves_json[child]) {
                elements.push({
                  data: { source: key, target: child },
                });
              }
            });
          }
        });

        const EDGE_COLOR = "#AAFDE9"

        // Initialize Cytoscape
        const cy = cytoscape({
          container: document.getElementById("cy"),
          elements: elements,
          style: [
            {
              selector: "node",
              style: {
                label: "data(label)",
                "background-color": (ele) => {
                  switch (ele.data("type")) {
                    // Settings: Node Color
                    case "Guard":
                      return "#1f77b4";
                    case "Pass":
                      return "#ff7f0e";
                    case "Submission":
                      return "#2ca02c";
                    case "Submission Defense":
                      return "#d62728";
                    case "Takedown":
                      return "#FF8E1F";
                    case "Sweep":
                      return "#4caf50";
                    default:
                      return "#888";
                  }
                },
                // node size scales with number of children (or num_grips fallback)
                width: (ele) => {
                  const childrenCount = ele.data("children")
                    ? ele.data("children").length
                    : 1;
                  const parentCount = ele.data("parent")
                    ? ele.data("parent").length
                    : 1;
                  return 30 + (childrenCount + parentCount) * 5;
                },
                height: (ele) => {
                  return ele.width();
                },
                // font size scales with number of grips (or children count)
                "font-size": (ele) => {
                  return ele.width() * 0.2;
                },
                color: "#fff",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "text-max-width": "50%",
                // Task: make font stay inside bubbles
              },
            },
            {
              selector: "edge",
              style: {
                width: 2,
                "line-color": EDGE_COLOR,
                "target-arrow-color": EDGE_COLOR,
                "target-arrow-shape": "triangle",
                "arrow-scale": 2,
                "curve-style": "straight",

                // Add padding so arrows stop outside node bounds
                "source-endpoint": "outside-to-node",
                "target-endpoint": "outside-to-node",

                // Use these to add extra space from node border if needed
                "source-distance-from-node": 5,
                "target-distance-from-node": 5,
              },
            },
          ],
          layout: { name: "preset" }, // don't auto-layout, we'll run our own below
        });

        function runLayout(mode) {
          if (mode === "concentric") {
            cy.layout({
              name: "concentric",
              concentric: (n) => n.degree(),
              levelWidth: () => 1,
              padding: 50,
            }).run();
            return;
          }

          // First run concentric to seed positions
          cy.layout({
            name: "concentric",
            concentric: (n) => n.degree(),
            levelWidth: () => 1,
            padding: 50,
          }).run();

          if (mode === "dagre") {
            cy.layout({
              name: "dagre",
              rankDir: "TB",
              rankSep: 50,
              nodeSep: 30,
              edgeSep: 10,
              fit: true,
              padding: 20,
            }).run();
          } else {
            // Then refine with cola
            cy.layout({
              name: "cola",
              animate: true,
              randomize: false,
              maxSimulationTime: 3000,
              fit: true,
              padding: 20,
              nodeSpacing: () => 20,
              avoidOverlap: true,
            }).run();
          }
        }

        runLayout(layoutSelect.value);
        layoutSelect.addEventListener("change", () => {
          runLayout(layoutSelect.value);
        });

        const maxWidth = 3;
        const minScale = 0.5;

        function updateEdgeWidths() {
          const z = cy.zoom();
          // thinner when zooming in; clamp between min/max
          const width = Math.min(maxWidth, maxWidth / z);
          const arrowScale = Math.min(1, width);
          cy.batch(() => {
            cy.edges().forEach((e) => e.style("width", width));
            cy.edges().forEach((e) => e.style("arrow-scale", arrowScale));
          });
        }

        function updateEdgeStyle(mode) {
          cy.edges().style("curve-style", mode);
        }


        function updateLabelSizing() {
          const z = cy.zoom();
          cy.nodes().forEach((n) => {
            const w = n.width();
            n.style({
              "font-size": Math.max(4, Math.min(w * 0.2, 16 / z)),
            });
          });
        }

        // Initial call
        updateEdgeWidths();
        updateLabelSizing();
        updateEdgeStyle(edgeStyleSelect.value);

        // Enable zoom/pan
        cy.userZoomingEnabled(true);
        cy.userPanningEnabled(true);

        // Optional: node click tooltip
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        document.body.appendChild(tooltip);
        tooltip.style.display = "none";

        cy.on("mouseover", "node", (evt) => {
          const node = evt.target;
          // Settings: Tooltip Text
          tooltip.innerHTML = `
                <strong>${node.data("label")}</strong><br>
                Parents: ${node.data("parents").join(", ")}<br>
                Children: ${node.data("children").join(", ")}<br>
                Area: ${node.data("area")}<br>
                Type: ${node.data("type")}
              `;
          tooltip.style.display = "block";
          console.log(evt);
        });

        cy.on("mousemove", (evt) => {
          tooltip.style.left = evt.originalEvent.pageX + 10 + "px";
          tooltip.style.top = evt.originalEvent.pageY + 10 + "px";
        });

        cy.on("mouseout", "node", () => {
          tooltip.style.display = "none";
        });

        cy.on("zoom", updateEdgeWidths);
        cy.on("zoom", updateLabelSizing);

        edgeStyleSelect.addEventListener("change", () => {
          updateEdgeStyle(edgeStyleSelect.value);
        });
      }

      loadGraph();
    </script>
  </body>
</html>
